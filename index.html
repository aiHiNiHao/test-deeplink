<!DOCTYPE html>
<html>
<body>
    <h2>登录成功</h2>
    <a href="https://aihinihao.github.io/test-deeplink/callback?status=success" 
       id="finalLink" 
       style="padding: 20px; display: block; background: blue; color: white;">
       确认返回 App
    </a>

    <script>
        // 1. 获取原始超长 URL 里的参数
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');

        if (code) {
            // 2. 关键：构造一个极其干净的跳转 URL，只保留 code
            // 确保 path 部分与你 Manifest 里的 pathPrefix 完全一致
            const cleanUrl = "https://aihinihao.github.io/test-deeplink/?code=" + encodeURIComponent(code);
            
            const link = document.getElementById('finalLink');
            link.onclick = () => { window.location.replace(cleanUrl); };

            // 3. 自动触发极简跳转
            setTimeout(() => {
                // 使用 replace 替换当前历史记录，防止按返回键死循环
                window.location.replace(cleanUrl);
            }, 100);

        } else {
            document.body.innerHTML = "<h2>未检测到授权码</h2>";
        }
    </script>
</body>
</html>
